<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="refresh" content="300"> <!-- kiosk safety reload -->
  <title>Musalla Bus Station - Live Departures</title>
  <style>
    :root{
      --bg:#071525;
      --text:#e8f2ff;
      --muted:#9fb4cc;
      --accent:#39a7ff;
      --good:#1ee6a8;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --border:rgba(255,255,255,0.10);
    }
    html,body{height:100%;}
    body{
      margin:0;
      background:radial-gradient(1200px 700px at 20% 10%, #0b2a4a 0%, var(--bg) 55%);
      color:var(--text);
      font-family:system-ui, "Segoe UI", Arial;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 28px;border-bottom:1px solid var(--border);
    }
    .t{font-size:28px;font-weight:900;letter-spacing:.2px;}
    .s{font-size:14px;color:var(--muted);margin-top:6px;}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .pill{
      padding:10px 14px;border-radius:999px;
      background:rgba(255,255,255,0.06);
      border:1px solid var(--border);
      font-weight:700;
    }
    .btn{
      cursor:pointer;user-select:none;
      padding:10px 14px;border-radius:12px;
      background:rgba(57,167,255,0.16);
      border:1px solid rgba(57,167,255,0.32);
      color:var(--text);font-weight:800;
    }
    .btn.off{
      background:rgba(255,255,255,0.06);
      border-color:var(--border);color:var(--muted);
    }
    .grid{display:grid;grid-template-columns: 1.2fr .8fr; gap:16px; padding:18px 18px 24px;}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
      overflow:hidden;
    }
    .card h2{margin:0;padding:14px 18px;border-bottom:1px solid var(--border);font-size:18px;letter-spacing:.2px;}
    .pad{padding:16px 18px;}
    .label{color:var(--muted);text-transform:uppercase;letter-spacing:.18em;font-size:12px;font-weight:800;}
    .big{font-size:66px;font-weight:950;letter-spacing:1px;}
    .muted{color:var(--muted);}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left;}
    th{color:var(--muted);font-size:12px;letter-spacing:.12em;text-transform:uppercase;}
    td.time{font-size:20px;font-weight:950;}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;letter-spacing:.08em;}
    .tag.good{background:rgba(30,230,168,0.16);border:1px solid rgba(30,230,168,0.35);color:var(--good);}
    .tag.warn{background:rgba(255,204,102,0.16);border:1px solid rgba(255,204,102,0.35);color:var(--warn);}
    .tag.danger{background:rgba(255,107,107,0.16);border:1px solid rgba(255,107,107,0.35);color:var(--danger);}
    .dest{font-weight:900;}
    .ticker{display:flex;justify-content:space-between;gap:12px;padding:10px 18px;border-top:1px solid var(--border);color:var(--muted);font-size:12px;}
    #err{display:none;margin:10px 18px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,107,107,0.35);background:rgba(255,107,107,0.12);color:#ffd6d6;font-weight:700;}
      .routecards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .rcard{border:1px solid var(--line);border-radius:14px;padding:10px;background:linear-gradient(180deg,#0b1220 0%, #0f172a 100%);box-shadow:0 2px 14px rgba(0,0,0,.22)}
    .rcard .top{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px;letter-spacing:.2px}
    .rcard .time{font-size:22px;font-weight:900;margin-top:6px}
    .rcard .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .rcard .meta span{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div>
    <div class="t">Musalla Bus Station - Live Departures</div>
    <div class="s" id="subtitle">Loading schedules...</div>
  </div>
  <div class="right">
    <div class="pill" id="clock">--:--</div>
    <div class="btn" id="soundBtn">Sound: ON</div>
    <div class="btn off" id="voiceBtn">Voice: OFF</div>
  </div>
</header>

<div id="err"></div>

<div class="grid">
  <div class="card">
    <h2>Next per Route</h2>
    <div class="pad">
      <div id="routeCards" class="routecards">
        <div class="muted">Loading...</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Next Departures (All Routes)</h2>
    <div class="pad">
      <table>
        <thead>
          <tr>
            <th style="width:14%">Time</th>
            <th style="width:16%">Countdown</th>
            <th style="width:18%">Status</th>
            <th style="width:16%">Bus</th>
            <th>Route</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="5" class="muted">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="ticker">
      <div id="lastUpdate">Last update: -</div>
      <div id="net">Online: -</div>
    </div>
  </div>

  <div class="card">
    <h2>Next Trip</h2>
    <div class="pad">
      <div class="label">Countdown</div>
      <div class="big" id="nextCountdown">--:--</div>
      <div style="height:12px"></div>
      <div class="label">Details</div>
      <div style="font-size:22px;font-weight:900" id="nextDetails">-</div>
      <div class="muted" style="margin-top:10px" id="nextExtra">-</div>
    </div>
    <div class="ticker">
      <div>Auto refresh every 1 minute</div>
      <div id="dateTag">Date: -</div>
    </div>
  </div>
</div>

<script>

(function(){
  "use strict";

  const VERSION = "1771323577";
  const CANDIDATE_URLS = [
    "data/schedules.json?v=" + VERSION,
    "./data/schedules.json?v=" + VERSION,
    "schedules.json?v=" + VERSION,
    "./schedules.json?v=" + VERSION
  ];

  const elRows = document.getElementById("rows");
  const elRouteCards = document.getElementById("routeCards");
  let pageIndex = 0;
  const elClock = document.getElementById("clock");
  const elSub = document.getElementById("subtitle");
  const elNextCountdown = document.getElementById("nextCountdown");
  const elNextDetails = document.getElementById("nextDetails");
  const elNextExtra = document.getElementById("nextExtra");
  const elLast = document.getElementById("lastUpdate");
  const elNet = document.getElementById("net");
  const elDateTag = document.getElementById("dateTag");
  const elErr = document.getElementById("err");

  let schedules = null;
  let soundOn = true;
  let voiceOn = false;
  // Persist Sound/Voice toggles across kiosk auto-refresh
  const LS_SOUND = "musalla_soundOn";
  const LS_VOICE = "musalla_voiceOn";
  function loadTogglePrefs(){
    try{
      const s = localStorage.getItem(LS_SOUND);
      const v = localStorage.getItem(LS_VOICE);
      // Default both ON for Musalla kiosk
      soundOn = (s === null) ? true : (s === "1");
      voiceOn = (v === null) ? true : (v === "1");
    }catch(e){ /* ignore */ }
  }
  function saveTogglePrefs(){
    try{
      localStorage.setItem(LS_SOUND, soundOn ? "1" : "0");
      localStorage.setItem(LS_VOICE, voiceOn ? "1" : "0");
    }catch(e){ /* ignore */ }
  }

  const pad2 = n => String(n).padStart(2,"0");
  const now = () => new Date();
  const hhmm = d => pad2(d.getHours()) + ":" + pad2(d.getMinutes());
  const ymd = d => d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());

  function showErr(msg){
    if(!elErr) return;
    elErr.style.display = "block";
    elErr.textContent = msg;
  }
  function clearErr(){
    if(!elErr) return;
    elErr.style.display = "none";
    elErr.textContent = "";
  }

  function parseTime(dateStr, t){
    const parts = String(t||"").split(":");
    const H = parseInt(parts[0]||"0",10);
    const M = parseInt(parts[1]||"0",10);
    const d = new Date(dateStr + "T00:00:00");
    d.setHours(H, M, 0, 0);
    return d;
  }

  // -------- Route colors (fixed for AJ routes) --------
  const ROUTE_COLORS = {
    "AJ1":"#1f4e79",
    "AJ2":"#1f9d55",
    "AJ3":"#f59e0b",
    "AJ4":"#ef4444",
    "AJ5":"#7c3aed",
    "AJ6":"#06b6d4",
    "AJ7":"#ec4899",
    "AJ8":"#8b5cf6",
    "AJ9":"#10b981",
    "AJ10":"#3b82f6",
    "AJ11":"#22c55e",
    "AJ12":"#eab308",
    "AJ13":"#f97316",
    "AJ14":"#a855f7",
    "AJ15":"#0ea5e9"
  };
  const ROUTE_PALETTE = ["#1f4e79","#1f9d55","#f59e0b","#ef4444","#7c3aed","#06b6d4","#ec4899","#8b5cf6","#10b981","#3b82f6"];

  function normalizeRouteKey(key){
    const s = String(key||"").toUpperCase().replace(/\s+/g,"");
    const m = s.match(/AJ0*([0-9]{1,2})/);
    if(m) return "AJ" + String(parseInt(m[1],10));
    return s;
  }
  function routeColor(key){
    const k = normalizeRouteKey(key);
    if(ROUTE_COLORS[k]) return ROUTE_COLORS[k];
    let h = 0;
    for(let i=0;i<k.length;i++){ h = ((h<<5)-h) + k.charCodeAt(i); h |= 0; }
    const idx = Math.abs(h) % ROUTE_PALETTE.length;
    return ROUTE_PALETTE[idx];
  }
  function routePriority(key){
    const k = normalizeRouteKey(key);
    const m = k.match(/^AJ([0-9]{1,2})$/);
    if(m) return parseInt(m[1],10);
    return 999;
  }

  function fmtCountdown(ms){
    if(ms < 0) ms = 0;
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const r = s % 60;
    const h = Math.floor(m/60);
    const mm = m % 60;
    if(h > 0) return h + ":" + pad2(mm) + ":" + pad2(r);
    return mm + ":" + pad2(r);
  }

  function statusFor(ms){
    const min = ms/60000;
    if(min <= 0.1) return ["DEPARTING", "danger"];
    if(min <= 2) return ["NOW BOARDING", "danger"];
    if(min <= 10) return ["SOON", "warn"];
    return ["SCHEDULED", "good"];
  }

  // ---------- sound + voice ----------
  let audioCtx = null;
  function beep(freq, durMs){
    if(!soundOn) return;
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.value = freq;
      g.gain.value = 0.08;
      o.connect(g);
      g.connect(audioCtx.destination);
      o.start();
      setTimeout(()=>{ try{o.stop();}catch(e){} }, durMs);
    }catch(e){}
  }
  function beepPattern(count, durMs, freq, gapMs){
    if(!soundOn) return;
    let i=0;
    const step = () => {
      if(i>=count) return;
      beep(freq, durMs);
      i++;
      setTimeout(step, durMs + gapMs);
    };
    step();
  }
  function speak(text, lang){
    if(!voiceOn) return;
    if(!("speechSynthesis" in window)) return;
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = lang || "en-US";
      u.rate = 0.95;
      u.pitch = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){}
  }
  function speakBilingual(enText, arText){
    if(!voiceOn) return;
    if(!("speechSynthesis" in window)) return;
    try{
      window.speechSynthesis.cancel();
      const en = new SpeechSynthesisUtterance(enText);
      en.lang = "en-US"; en.rate = 1.0; en.pitch = 1.0;
      const ar = new SpeechSynthesisUtterance(arText);
      ar.lang = "ar-AE"; ar.rate = 0.95; ar.pitch = 1.0;
      window.speechSynthesis.speak(en);
      window.speechSynthesis.speak(ar);
    }catch(e){}
  }


  // prevent repeated spam: per trip per stage
  function shouldAlert(tripId, stageKey, minIntervalMs){
    const key = "alert_" + tripId + "_" + stageKey;
    const last = parseInt(localStorage.getItem(key)||"0",10);
    const t = Date.now();
    if(t - last >= minIntervalMs){
      localStorage.setItem(key, String(t));
      return true;
    }
    return false;
  }

  function runAlerts(nextTrips){
    if(!nextTrips || !nextTrips.length) return;
    const tNow = now().getTime();
    nextTrips.slice(0,3).forEach(tr => {
      const ms = tr.dt.getTime() - tNow;
      const mins = ms/60000;
      const tripId = tr.tripId;

      if(mins <= 0.05){
        if(shouldAlert(tripId, "at", 10*60*1000)){
          beepPattern(5, 160, 980, 130);
          speakBilingual("Departure now. Route " + tr.route + ". Bus " + tr.bus + ".", "تنبيه. الانطلاق الآن. خط " + tr.route + ". حافلة " + tr.bus + ".");
        }
        return;
      }

      if(mins <= 2){
        if(shouldAlert(tripId, "m2", 30*1000)){
          beepPattern(3, 140, 900, 110);
          speakBilingual("Now boarding. Route " + tr.route + ". Bus " + tr.bus + ". Departs at " + tr.time + ".", "تنبيه. يتم الآن الصعود. خط " + tr.route + ". حافلة " + tr.bus + ". موعد الانطلاق " + tr.time + ".");
        }
        return;
      }

      if(mins <= 5){
        if(shouldAlert(tripId, "m5", 60*1000)){
          beepPattern(2, 140, 820, 100);
          if(mins > 4.0) speakBilingual("Attention please. Route " + tr.route + ". Bus " + tr.bus + ". Departure in five minutes.", "تنبيه. خط " + tr.route + ". حافلة " + tr.bus + ". الانطلاق بعد خمس دقائق.");
        }
      }
    });
  }

  // ---------- schedules reader (supports BOTH schemas) ----------
  // New schema (recommended):
  // { routes: [ { route, display_name, days:[ {date, profile, buses:[{bus, departures:[HH:MM]}]} ] } ] }
  // Old schema:
  // { routes: [ { route, name, buses:[{bus, times:[HH:MM]}]} ] }
  function flattenTrips(dateStr){
    if(!schedules) return [];
    const trips = [];
    const routes = schedules.routes || [];

    for(const r of routes){
      const displayRoute = r.display_name || r.name || r.route || "-";

      if(Array.isArray(r.days) && r.days.length){
        const day = r.days.find(x => x.date === dateStr) || r.days[0];
        if(!day) continue;
        const buses = day.buses || [];
        for(const b of buses){
          const busName = b.bus || b.name || "-";
          const depList = b.departures || b.times || [];
          for(const t of depList){
            const dt = parseTime(dateStr, t);
            trips.push({
              route: displayRoute,
              bus: busName,
              time: t,
              dt: dt,
              tripId: dateStr + "__" + (r.route||displayRoute) + "__" + busName + "__" + t
            });
          }
        }
      }else{
        // old schema fallback
        const buses = r.buses || [];
        for(const b of buses){
          const busName = b.bus || b.name || "-";
          const depList = b.times || b.departures || [];
          for(const t of depList){
            const dt = parseTime(dateStr, t);
            trips.push({
              route: displayRoute,
              bus: busName,
              time: t,
              dt: dt,
              tripId: dateStr + "__" + (r.route||displayRoute) + "__" + busName + "__" + t
            });
          }
        }
      }
    }

    trips.sort((a,b)=>a.dt-b.dt);
    return trips;
  }

  function pickDate(){ return ymd(now()); }

  function nextPerRoute(trips){
    const map = {};
    for(const t of trips){
      const k = String(t.route||"");
      if(!map[k] || map[k].dep > t.dep) map[k] = t;
    }
    return Object.values(map).sort((a,b)=> (routePriority(a.route)-routePriority(b.route)) || (a.route||"").localeCompare(b.route||""));
  }

  function renderRouteCards(allNext){
    if(!elRouteCards) return;
    const per = nextPerRoute(allNext);
    if(!per.length){
      elRouteCards.innerHTML = `<div class="muted">No upcoming trips</div>`;
      return;
    }
    const html = per.map(t=>{
      const col = routeColor(t.route);
      return `
        <div class="rcard">
          <div class="top">
            <div>${pillHTML(t.route, col)}</div>
            <div class="muted">${escapeHTML(t.bus||"")}</div>
          </div>
          <div class="time" style="color:${col}">${escapeHTML(t.time)}</div>
          <div class="meta">
            <span>${escapeHTML(t.countdown)}</span>
            <span>${escapeHTML(t.statusText)}</span>
          </div>
        </div>
      `;
    }).join("");
    elRouteCards.innerHTML = html;
  }

  let rotTimer = null;
  function scheduleAutoRotate(pages){
    if(rotTimer) return;
    if(pages <= 1) return;
    rotTimer = setInterval(()=>{
      pageIndex = (pageIndex + 1) % pages;
      render();
    }, 8000);
  }

  function render(){
    const dStr = pickDate();
    elDateTag.textContent = "Date: " + dStr;

    const tNow = now().getTime();
    const all = flattenTrips(dStr).filter(x => x.dt.getTime() >= tNow - 30*1000);
    const next = all.slice(0,10);

    if(!next.length){
      elRows.innerHTML = '<tr><td colspan="5" class="muted">No upcoming trips for today.</td></tr>';
      elNextCountdown.textContent = "--:--";
      elNextDetails.textContent = "-";
      elNextExtra.textContent = "-";
      elSub.textContent = "No upcoming trips right now.";
      return;
    }

    const top = next[0];
    const msTop = top.dt.getTime() - tNow;
    elNextCountdown.textContent = fmtCountdown(msTop);
    elNextDetails.textContent = top.route + "  |  Bus " + top.bus + "  |  " + top.time;
    elNextExtra.textContent = "Sound alerts start 5 minutes before departure.";

    const rowsHtml = next.map(tr => {
      const ms = tr.dt.getTime() - tNow;
      const cd = fmtCountdown(ms);
      const st = statusFor(ms);
      return '<tr>' +
        '<td class="time">' + tr.time + '</td>' +
        '<td>' + cd + '</td>' +
        '<td><span class="tag ' + st[1] + '">' + st[0] + '</span></td>' +
        '<td style="font-weight:900">' + tr.bus + '</td>' +
        '<td><span class="dest">' + tr.route + '</span></td>' +
      '</tr>';
    }).join("");
    elRows.innerHTML = rowsHtml;

    elSub.textContent = "Showing next " + next.length + " departures across all routes";
    runAlerts(next);
  }

  async function load(){
    clearErr();
    elNet.textContent = "Online: checking...";
    elLast.textContent = "Last update: loading...";
    let lastErr = null;

    for(const url of CANDIDATE_URLS){
      try{
        const r = await fetch(url, {cache:"no-store"});
        if(!r.ok) throw new Error("HTTP " + r.status + " for " + url);
        const data = await r.json();
        schedules = data;
        localStorage.setItem("schedules_cache", JSON.stringify(data));
        elNet.textContent = "Online: YES";
        elLast.textContent = "Last update: " + new Date().toLocaleString();
        render();
        return;
      }catch(e){
        lastErr = e;
      }
    }

    // cache fallback
    const cached = localStorage.getItem("schedules_cache");
    if(cached){
      try{
        schedules = JSON.parse(cached);
        elNet.textContent = "Online: NO (cached)";
        elLast.textContent = "Last update: cached";
        showErr("Offline mode: using last cached schedules.");
        render();
        return;
      }catch(e){
        lastErr = e;
      }
    }

    elNet.textContent = "Online: NO";
    elLast.textContent = "Last update: -";
    showErr("Failed to load schedules.json. Check that schedules.json exists at /bus-schedules/data/ or /bus-schedules/.");
    if(lastErr && console) console.error(lastErr);
    elRows.innerHTML = '<tr><td colspan="5" class="muted">No data loaded.</td></tr>';
    elSub.textContent = "Failed to load schedules.";
  }

  function tick(){
    elClock.textContent = hhmm(now());
    render();
  }

  function setBtn(btn, on, labelOn, labelOff){
    btn.textContent = (on ? labelOn : labelOff);
    btn.classList.toggle("off", !on);
  }

  document.getElementById("soundBtn").onclick = () => {
    soundOn = !soundOn;
    setBtn(document.getElementById("soundBtn"), soundOn, "Sound: ON", "Sound: OFF");
    saveTogglePrefs();
    if(soundOn) beepPattern(2, 140, 880, 100);
  };
  document.getElementById("voiceBtn").onclick = () => {
    voiceOn = !voiceOn;
    setBtn(document.getElementById("voiceBtn"), voiceOn, "Voice: ON", "Voice: OFF");
    saveTogglePrefs();
    if(voiceOn) speakBilingual("Voice alerts enabled.", "تم تفعيل التنبيهات الصوتية.");
  };

  // kick off
  loadTogglePrefs();
  setBtn(document.getElementById("soundBtn"), soundOn, "Sound: ON", "Sound: OFF");
  setBtn(document.getElementById("voiceBtn"), voiceOn, "Voice: ON", "Voice: OFF");
  saveTogglePrefs();
  elClock.textContent = hhmm(now());
  load();
  setInterval(tick, 1000);
  setInterval(load, 60*1000);
})();

</script>
</body>
</html>
