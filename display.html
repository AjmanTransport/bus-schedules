<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="refresh" content="300"> <!-- safety reload every 5 minutes -->
  <title>Musalla Station  -  Live Departures</title>
  <style>
    :root{
      --bg:#071525;
      --card:#0d2136;
      --card2:#0b1b2d;
      --text:#e8f2ff;
      --muted:#9fb4cc;
      --accent:#39a7ff;
      --good:#1ee6a8;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --border:rgba(255,255,255,.08);
    }
    html,body{height:100%;}
    body{margin:0;background:radial-gradient(1200px 700px at 20% 10%, #0b2a4a 0%, var(--bg) 55%); color:var(--text); font-family:system-ui,Segoe UI,Arial;}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;border-bottom:1px solid var(--border);}
    header .t{font-size:28px;font-weight:900;letter-spacing:.2px;}
    header .s{font-size:14px;color:var(--muted);margin-top:6px;}
    .right{display:flex;gap:10px;align-items:center;}
    .pill{padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--border);font-weight:700;}
    .btn{cursor:pointer;user-select:none;padding:10px 14px;border-radius:12px;background:rgba(57,167,255,.16);border:1px solid rgba(57,167,255,.32);color:var(--text);font-weight:800;}
    .btn.off{background:rgba(255,255,255,.06);border-color:var(--border);color:var(--muted);}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr; gap:16px; padding:18px 18px 24px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;}
    .card h2{margin:0;padding:14px 18px;border-bottom:1px solid var(--border);font-size:18px;letter-spacing:.2px;}
    .big{font-size:66px;font-weight:950;letter-spacing:1px;}
    .label{color:var(--muted);font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:1px;}
    .pad{padding:18px;}
    .row{display:flex;gap:18px;align-items:flex-end;justify-content:space-between;}
    .kpi{display:flex;flex-direction:column;gap:6px;}
    .muted{color:var(--muted);}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:14px 16px;border-bottom:1px solid var(--border);font-size:18px;}
    th{color:var(--muted);font-size:14px;text-transform:uppercase;letter-spacing:1px;text-align:left;}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;font-size:13px;font-weight:900;border:1px solid var(--border);}
    .tag.good{color:var(--good);border-color:rgba(30,230,168,.35);background:rgba(30,230,168,.08);}
    .tag.warn{color:var(--warn);border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.08);}
    .tag.danger{color:var(--danger);border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.08);}
    .dest{font-weight:900;}
    .time{font-weight:950;font-size:22px;letter-spacing:.5px;}
    .ticker{padding:12px 18px;border-top:1px solid var(--border);display:flex;justify-content:space-between;color:var(--muted);font-size:14px;}
  </style>
</head>
<body>
<header>
  <div>
    <div class="t">Musalla Bus Station  -  Live Departures</div>
    <div class="s" id="subtitle">Loading schedules...</div>
  </div>
  <div class="right">
    <div class="pill" id="clock">--:--</div>
    <div class="btn" id="soundBtn">Sound: ON</div>
    <div class="btn off" id="voiceBtn">Voice: OFF</div>
  </div>
</header>

<div class="grid">
  <div class="card">
    <h2>Next Departures (All Routes)</h2>
    <div class="pad">
      <table>
        <thead>
          <tr>
            <th style="width:140px">Time</th>
            <th style="width:140px">Countdown</th>
            <th style="width:140px">Status</th>
            <th style="width:170px">Bus</th>
            <th>Route</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="5" class="muted">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="ticker">
      <div id="lastUpdate">Last update:  - </div>
      <div id="net">Online:  - </div>
    </div>
  </div>

  <div class="card">
    <h2>Next Trip</h2>
    <div class="pad">
      <div class="label">Countdown</div>
      <div class="big" id="nextCountdown">--:--</div>
      <div style="height:12px"></div>
      <div class="label">Details</div>
      <div style="font-size:22px;font-weight:900" id="nextDetails"> - </div>
      <div class="muted" style="margin-top:10px" id="nextExtra"> - </div>
    </div>
    <div class="ticker">
      <div>Auto refresh every 5 minutes</div>
      <div id="dateTag">Date:  - </div>
    </div>
  </div>
</div>

<script>
(() => {
  const VERSION = "1771226935";
  const JSON_URL = "data/schedules.json?v=" + VERSION;

  const elRows = document.getElementById("rows");
  const elClock = document.getElementById("clock");
  const elSub = document.getElementById("subtitle");
  const elNextCountdown = document.getElementById("nextCountdown");
  const elNextDetails = document.getElementById("nextDetails");
  const elNextExtra = document.getElementById("nextExtra");
  const elLast = document.getElementById("lastUpdate");
  const elNet = document.getElementById("net");
  const elDateTag = document.getElementById("dateTag");

  let schedules = null;
  let soundOn = true;
  let voiceOn = false;

  // ---------- helpers ----------
  const pad2 = n => String(n).padStart(2,"0");
  const now = () => new Date();
  const hhmm = d => pad2(d.getHours()) + ":" + pad2(d.getMinutes());
  const ymd = d => d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
  const parseTime = (ymdStr, t) => {
    const [H,M] = (t||"").split(":").map(x=>parseInt(x,10));
    const [Y,Mo,Da] = ymdStr.split("-").map(x=>parseInt(x,10));
    return new Date(Y, Mo-1, Da, H||0, M||0, 0, 0);
  };
  const fmtCountdown = (ms) => {
    if(ms < 0) ms = 0;
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const r = s%60;
    const h = Math.floor(m/60);
    const mm = m%60;
    if(h>0) return `${h}:${pad2(mm)}:${pad2(r)}`;
    return `${mm}:${pad2(r)}`;
  };
  const statusFor = (ms) => {
    const min = ms/60000;
    if(min <= 0.1) return ["DEPARTING", "danger"];
    if(min <= 2) return ["NOW BOARDING", "danger"];
    if(min <= 5) return ["BOARDING SOON", "warn"];
    return ["SCHEDULED", "good"];
  };

  // ---------- sound ----------
  function beepPattern(count, gapMs, freq=880, dur=120){
    if(!soundOn) return;
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if(!AudioContext) return;
    const ctx = new AudioContext();
    let t = ctx.currentTime;
    for(let i=0;i<count;i++){
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = freq;
      g.gain.value = 0.08;
      o.connect(g); g.connect(ctx.destination);
      o.start(t);
      o.stop(t + dur/1000);
      t += (dur + gapMs)/1000;
    }
    setTimeout(()=>{ try{ctx.close();}catch(e){} }, (count*(dur+gapMs))+400);
  }

  function speak(text){
    if(!voiceOn) return;
    if(!("speechSynthesis" in window)) return;
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 0.95;
      u.pitch = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  // ---------- alert logic ----------
  // stages:
  //  -5min : every 60s until -2min
  //  -2min : every 30s until departure
  //  0     : once
  function shouldAlert(tripId, stageKey, minIntervalMs){
    const key = `alert_${tripId}_${stageKey}`;
    const last = parseInt(localStorage.getItem(key)||"0",10);
    const t = Date.now();
    if(t - last >= minIntervalMs){
      localStorage.setItem(key, String(t));
      return true;
    }
    return false;
  }

  function runAlerts(nextTrips){
    if(!nextTrips || !nextTrips.length) return;
    const tNow = now().getTime();

    // consider top 3 only (avoid noise if many routes depart close together)
    nextTrips.slice(0,3).forEach(tr => {
      const ms = tr.dt.getTime() - tNow;
      const mins = ms/60000;
      const tripId = tr.tripId;

      if(mins <= 0.05){
        if(shouldAlert(tripId, "at", 10*60*1000)){ // once-ish
          beepPattern(5, 160, 980, 130);
          speak(`Departure now. Route ${tr.route}. Bus ${tr.bus}.`);
        }
        return;
      }

      if(mins <= 2){
        if(shouldAlert(tripId, "m2", 30*1000)){
          beepPattern(3, 140, 900, 110);
          speak(`Now boarding. Route ${tr.route}. Bus ${tr.bus}. Departs at ${tr.time}.`);
        }
        return;
      }

      if(mins <= 5){
        if(shouldAlert(tripId, "m5", 60*1000)){
          beepPattern(2, 140, 820, 100);
          // voice only on first of the minute window
          if(mins > 4.0) speak(`Attention please. Route ${tr.route}. Bus ${tr.bus}. Departure in five minutes.`);
        }
      }
    });
  }

  // ---------- render ----------
    function flattenTrips(dateStr){
  // schedules.json schema:
  // { routes: [ { route, display_name, days:[ {date, profile, buses:[{bus, departures:[HH:MM]}]} ] } ] }
  if(!schedules) return [];
  const trips = [];
  const routes = (schedules.routes||[]);
  for(const r of routes){
    const days = (r.days||[]);
    const day = days.find(x => x.date === dateStr) || days[0];
    if(!day) continue;
    for(const b of (day.buses||[])){
      for(const t of (b.departures||[])){
        const dt = parseTime(dateStr, t);
        trips.push({
          route: r.display_name || r.route || " - ",
          bus: b.bus || " - ",
          time: t,
          dt,
          tripId: `${dateStr}__${(r.route||"x")}__${(b.bus||"y")}__${t}`
        });
      }
    }
  }
  trips.sort((a,b)=>a.dt-b.dt);
  return trips;
}
      }
    }
    trips.sort((a,b)=>a.dt-b.dt);
    return trips;
  }

  function pickDate(){
    // always show today (station screen)
    const d = now();
    return ymd(d);
  }

  function render(){
    const dStr = pickDate();
    elDateTag.textContent = "Date: " + dStr;

    const tNow = now().getTime();
    const all = flattenTrips(dStr).filter(x => x.dt.getTime() >= tNow - 30*1000); // allow just passed
    const next = all.slice(0,10);

    if(!next.length){
      elRows.innerHTML = `<tr><td colspan="5" class="muted">No upcoming trips today.</td></tr>`;
      elNextCountdown.textContent = "--:--";
      elNextDetails.textContent = " - ";
      elNextExtra.textContent = " - ";
      return;
    }

    // Next trip card
    const top = next[0];
    const msTop = top.dt.getTime() - tNow;
    elNextCountdown.textContent = fmtCountdown(msTop);
    elNextDetails.textContent = `${top.route}  *  Bus ${top.bus}  *  ${top.time}`;
    elNextExtra.textContent = `Updated automatically * Sound alerts start 5 minutes before departure`;

    // Table
    const rowsHtml = next.map(tr => {
      const ms = tr.dt.getTime() - tNow;
      const cd = fmtCountdown(ms);
      const [txt, cls] = statusFor(ms);
      return `
        <tr>
          <td class="time">${tr.time}</td>
          <td>${cd}</td>
          <td><span class="tag ${cls}">${txt}</span></td>
          <td style="font-weight:900">${tr.bus}</td>
          <td><span class="dest">${tr.route}</span></td>
        </tr>`;
    }).join("");
    elRows.innerHTML = rowsHtml;

    // subtitle
    elSub.textContent = `Showing next ${next.length} departures across all routes`;

    // alerts
    runAlerts(next);
  }

  // ---------- load with offline fallback ----------
  async function load(){
    elNet.textContent = "Online: checking...";
    try{
      const r = await fetch(JSON_URL, {cache:"no-store"});
      if(!r.ok) throw new Error("HTTP "+r.status);
      const data = await r.json();
      schedules = data;
      localStorage.setItem("schedules_cache", JSON.stringify(data));
      elNet.textContent = "Online: YES";
      elLast.textContent = "Last update: " + new Date().toLocaleString();
    }catch(e){
      const cached = localStorage.getItem("schedules_cache");
      if(cached){
        try{
          schedules = JSON.parse(cached);
          elNet.textContent = "Online: NO (using last cached schedules)";
          elLast.textContent = "Last update: cached";
        }catch(_){}
      }else{
        elNet.textContent = "Online: NO";
        elLast.textContent = "Last update:  - ";
      }
    }
    render();
  }

  // clock + periodic
  function tick(){
    elClock.textContent = hhmm(now());
    render();
  }

  // toggles
  function setBtn(btn, on, labelOn, labelOff){
    btn.textContent = (on ? labelOn : labelOff);
    btn.classList.toggle("off", !on);
  }
  document.getElementById("soundBtn").onclick = () => {
    soundOn = !soundOn;
    setBtn(document.getElementById("soundBtn"), soundOn, "Sound: ON", "Sound: OFF");
    if(soundOn) beepPattern(2, 140, 880, 100);
  };
  document.getElementById("voiceBtn").onclick = () => {
    voiceOn = !voiceOn;
    setBtn(document.getElementById("voiceBtn"), voiceOn, "Voice: ON", "Voice: OFF");
    if(voiceOn) speak("Voice alerts enabled.");
  };

  // start
  elClock.textContent = hhmm(now());
  load();
  setInterval(tick, 1000);        // smooth countdown
  setInterval(load, 60*1000);     // reload JSON every minute (keeps in sync)
})();
</script>
</body>
</html>
