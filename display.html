<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="refresh" content="300"><!-- kiosk safety reload -->
  <title>Musalla Bus Station - Live Departures</title>
  <style>

  :root{
    /* Monochrome kiosk theme (high-contrast, readable from distance) */
    --bg:#0b0c0e;
    --panel:#111316;
    --panel2:#0f1012;
    --text:#f5f6f7;
    --muted:#c8cbd0;
    --muted2:#9aa0a8;
    --border:rgba(255,255,255,.12);
    --border2:rgba(255,255,255,.18);
    --shadow: 0 18px 60px rgba(0,0,0,.55);
    --shadow2: 0 10px 30px rgba(0,0,0,.45);
    --radius:22px;

    /* Route indicators (kept, but monochrome) */
    --aj1:#ffffff;
    --aj2:#d7d7d7;
    --aj3:#bdbdbd;
    --accent:#ffffff;

    /* Typography scaling */
    --h1: clamp(18px, 1.4vw + 14px, 28px);
    --h2: clamp(16px, 1.2vw + 12px, 22px);
    --base: clamp(14px, 1.0vw + 10px, 18px);
    --big: clamp(28px, 2.4vw + 18px, 54px);
    --clock: clamp(18px, 1.5vw + 12px, 30px);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    background:
      radial-gradient(1200px 700px at 12% 8%, rgba(255,255,255,.08), transparent 55%),
      radial-gradient(900px 600px at 90% 15%, rgba(255,255,255,.05), transparent 60%),
      radial-gradient(1200px 700px at 40% 120%, rgba(255,255,255,.06), transparent 55%),
      linear-gradient(180deg, #070708 0%, #0b0c0e 55%, #090a0c 100%);
    color:var(--text);
    letter-spacing:.2px;
  }

  /* ===== Header ===== */
  header{
    position:sticky;
    top:0;
    z-index:30;
    padding:18px 22px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:18px;
    background:
      linear-gradient(180deg, rgba(10,11,13,.88), rgba(10,11,13,.55));
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--border);
  }

  .titleWrap{min-width:0}
  .t{
    font-size:var(--h1);
    font-weight:800;
    line-height:1.15;
    text-transform:none;
    color:var(--text);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .s{
    margin-top:6px;
    font-size:var(--base);
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

  .pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:10px 14px;
    border-radius:999px;
    border:1px solid var(--border);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    box-shadow: var(--shadow2);
    color:var(--text);
    font-weight:800;
    font-size:var(--clock);
    letter-spacing:.5px;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:10px 14px;
    border-radius:14px;
    border:1px solid var(--border);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
    color:var(--text);
    font-weight:800;
    font-size:var(--base);
    cursor:pointer;
    user-select:none;
    box-shadow: var(--shadow2);
    transition: transform .12s ease, border-color .12s ease, background .12s ease;
  }
  .btn:hover{transform: translateY(-1px); border-color:var(--border2)}
  .btn:active{transform: translateY(0px) scale(.99)}
  .btn:focus-visible{outline:3px solid rgba(255,255,255,.35); outline-offset:2px}

  .ico{display:inline-flex; width:22px; height:22px}
  .ico svg{width:22px; height:22px; fill:var(--text); opacity:.92}

  /* ===== Error ===== */
  #err{
    margin:12px 22px 0;
    padding:0;
    color:#fff;
  }

  /* ===== Layout ===== */
  .grid{
    padding:18px 22px 26px;
    display:grid;
    grid-template-columns: 1.25fr .75fr;
    gap:16px;
  }
  @media (max-width: 1050px){
    .grid{grid-template-columns:1fr}
  }

  .card{
    background:
      linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
    border:1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }

  .card h2{
    margin:0;
    padding:18px 18px 10px;
    font-size:var(--h2);
    font-weight:900;
    letter-spacing:.2px;
  }

  .pad{padding:0 18px 18px}

  .label{
    font-size:var(--base);
    color:var(--muted2);
    font-weight:800;
    letter-spacing:.2px;
  }
  .big{
    font-size:var(--big);
    font-weight:1000;
    letter-spacing:1px;
    line-height:1.0;
  }
  .muted{color:var(--muted2)}

  /* ===== Next departures summary bar ===== */
  .topBar{
    margin:0 18px 12px;
    padding:14px 14px;
    border-radius:18px;
    border:1px solid var(--border);
    background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.10));
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .topSmall{color:var(--muted2); font-weight:800; font-size:var(--base)}
  .topBig{
    font-size: clamp(34px, 3.2vw + 18px, 64px);
    font-weight:1000;
    letter-spacing:1.5px;
    line-height:1;
  }
  .topRoute{
    margin-top:6px;
    color:var(--muted);
    font-weight:800;
    font-size: clamp(14px, 1.1vw + 10px, 20px);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width: 72ch;
  }

  /* ===== Table ===== */
  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    overflow:hidden;
    border-radius:16px;
    border:1px solid var(--border);
    background: rgba(0,0,0,.18);
  }
  thead th{
    position:sticky;
    top:0;
    z-index:5;
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
    color:var(--text);
    text-align:left;
    padding:14px 14px;
    font-size: var(--base);
    letter-spacing:.3px;
    font-weight:1000;
    border-bottom:1px solid var(--border);
  }
  tbody td{
    padding:14px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    font-size: clamp(14px, 1.0vw + 10px, 20px);
    font-weight:800;
    color:var(--text);
  }
  tbody tr:last-child td{border-bottom:none}

  /* zebra + hover focus for kiosk readability */
  tbody tr:nth-child(odd) td{background: rgba(255,255,255,.02)}
  tbody tr:hover td{background: rgba(255,255,255,.06)}
  tbody tr.isNext td{
    background: rgba(255,255,255,.10) !important;
  }

  /* ===== Tags / status badges ===== */
  .tag{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.06);
    font-weight:1000;
    letter-spacing:.3px;
    font-size: var(--base);
    white-space:nowrap;
  }

  /* ===== Route cards ===== */
  .cards{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
    padding:0 0 18px 0;
  }
  .rcard{
    margin:0 18px;
    border-radius:18px;
    border:1px solid var(--border);
    background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.08));
    box-shadow: var(--shadow2);
    overflow:hidden;
  }
  .rT{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:14px 14px 10px;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .rL{
    display:flex;
    flex-direction:column;
    min-width:0;
  }
  .rName{
    font-size: clamp(16px, 1.2vw + 12px, 24px);
    font-weight:1000;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .rSub{
    margin-top:4px;
    color:var(--muted);
    font-weight:800;
    font-size: var(--base);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .rB{
    padding:12px 14px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }

  /* subtle route indicator strip (monochrome) */
  .rcard[data-color="aj1"]{border-left:6px solid var(--aj1)}
  .rcard[data-color="aj2"]{border-left:6px solid var(--aj2)}
  .rcard[data-color="aj3"]{border-left:6px solid var(--aj3)}

  /* ===== Footer ticker ===== */
  .ticker{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:12px 18px 16px;
    color:var(--muted2);
    font-weight:800;
    font-size: var(--base);
  }

  /* ===== Notification overlay ===== */
  .notifOverlay{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:22px;
    background: rgba(0,0,0,.65);
    backdrop-filter: blur(10px);
    z-index:60;
  }
  .notifCard{
    width:min(980px, 96vw);
    border-radius: 22px;
    border:1px solid rgba(255,255,255,.22);
    background: linear-gradient(180deg, rgba(20,20,22,.95), rgba(12,12,13,.92));
    box-shadow: 0 30px 120px rgba(0,0,0,.75);
    overflow:hidden;
  }
  .notifHeader{
    padding:16px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid rgba(255,255,255,.12);
  }
  .notifTitle{
    font-size: clamp(18px, 1.4vw + 12px, 26px);
    font-weight:1000;
    letter-spacing:.3px;
  }
  .notifClose{
    width:42px;
    height:42px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    color:var(--text);
    font-size:28px;
    line-height:1;
    cursor:pointer;
    font-weight:900;
  }
  .notifClose:hover{background: rgba(255,255,255,.10)}
  .notifBody{
    padding:18px;
    color:var(--text);
    font-size: clamp(16px, 1.2vw + 12px, 22px);
    font-weight:800;
  }
  .notifFooter{
    padding:14px 18px;
    border-top:1px solid rgba(255,255,255,.12);
    display:flex;
    justify-content:flex-end;
  }
  .notifMeta{
    color:var(--muted);
    font-weight:900;
    font-size: var(--base);
  }

  /* Accessibility / reduced motion */
  @media (prefers-reduced-motion: reduce){
    *{transition:none !important; scroll-behavior:auto !important}
  }

  </style>
</head>
<body>
<header>
  <div class="titleWrap">
    <div class="t">Musalla Bus Station - Live Departures هيئة النقل عجمان - نظام جدولة مواعيد رحلات النقل العام - محطة المصلي الرئيسية</div>
    <div class="s" id="subtitle">Loading schedules...</div>
  </div>
  <div class="right">
    <div class="pill" id="clock">--:--</div>
    <button class="btn" id="soundBtn" type="button">
      <span class="ico" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M3 10v4h4l5 4V6L7 10H3z"/><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
      </span>
      <span id="soundTxt">Sound: ON</span>
    </button>
    <button class="btn" id="voiceBtn" type="button">
      <span class="ico" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3z"/><path d="M19 11a7 7 0 0 1-14 0H3a9 9 0 0 0 18 0h-2z"/><path d="M11 19v3h2v-3h-2z"/></svg>
      </span>
      <span id="voiceTxt">Voice: ON</span>
    </button>
  </div>
</header>

<div id="err"></div>

<div id="notifOverlay" class="notifOverlay" style="display:none" aria-live="assertive">
  <div class="notifCard" role="dialog" aria-modal="true">
    <div class="notifHeader">
      <div class="notifTitle" id="notifTitle">Notification</div>
      <button class="notifClose" id="notifClose" type="button" aria-label="Close">×</button>
    </div>
    <div class="notifBody" id="notifContent"></div>
    <div class="notifFooter">
      <div class="notifMeta">
        <span id="notifCreated"></span>
      </div>
      <div class="notifCountdown">
        <span class="pill" id="notifTimer">00:00</span>
      </div>
    </div>
  </div>
</div>

<div class="grid">
  <div class="card">
    <h2>Next Departures (All Routes) الرحلات النالية لكل الخطوط مرتبة حسب اقرب رحلة</h2>

    <div class="topBar">
      <div class="left">
        <div class="topSmall">Next trip countdown الزمن المتبقي لافرب رحلة</div>
        <div class="topBig" id="topCountdown">--:--</div>
        <div class="topRoute" id="topDetails">-</div>
      </div>
      <div class="right">
        <div class="pill" id="dateTag">Date: -</div>
        <div class="pill" id="rotationTag">Showing 1–10</div>
      </div>
    </div>

    <div class="pad" style="padding-top:10px">
      <table>
        <thead>
          <tr>
            <th style="width:13%">Time</th>
            <th style="width:15%">Countdown</th>
            <th style="width:16%">Status</th>
            <th style="width:16%">Bus</th>
            <th style="width:16%">Route</th>
            <th>Destination</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="6" class="muted">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="ticker">
      <div id="lastUpdate">Last update: -</div>
      <div id="net">Online: -</div>
    </div>
  </div>

  <div class="card">
    <h2>Next per Route اقرب رحلة لكل خط</h2>
    <div class="pad">
      <div class="cards" id="routeCards">
        <div class="muted">Loading...</div>
      </div>
    </div>
    <div class="ticker">
      <div id="serviceState">-</div>
      <div>Auto refresh every 1 minute</div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  const VERSION = "1771702707";
  const CANDIDATE_URLS = [
    "data/schedules.json?v=" + VERSION,
    "./data/schedules.json?v=" + VERSION,
    "schedules.json?v=" + VERSION,
    "./schedules.json?v=" + VERSION
  ];

  // Station popup notification (written by the scheduler app to data/notification.json)
  const NOTIF_URLS = [
    "data/notification.json?t=",
    "./data/notification.json?t=",
    "notification.json?t=",
    "./notification.json?t="
  ];

  /* Route priority order (AJ1, AJ2, AJ3...) */
  const ROUTE_PRIORITY = [
    "AJ1","AJ2","AJ3","AJ4","AJ5","AJ6","AJ7","AJ8","AJ9","AJ10",
    "UAQ","SHJ","DXB"
  ];

  /* Fixed colors per route */
  const ROUTE_COLORS = {
    "AJ1":"var(--aj1)",
    "AJ2":"var(--aj2)",
    "AJ3":"var(--aj3)",
    "AJ4":"var(--aj4)",
    "AJ5":"var(--aj5)",
    "AJ6":"var(--aj6)",
    "AJ7":"var(--aj7)",
    "AJ8":"var(--aj8)",
    "AJ9":"var(--aj9)",
    "AJ10":"var(--aj10)",
    "AJ11":"var(--aj11)",
    "AJ12":"var(--aj12)",
    "AJ13":"var(--aj13)",
    "AJ14":"var(--aj14)",
    "AJ15":"var(--aj15)",
    "UAQ":"var(--uaq)",
    "SHJ":"var(--shj)",
    "DXB":"var(--dxb)"
  };

  const elRows = document.getElementById("rows");
  const elClock = document.getElementById("clock");
  const elSub = document.getElementById("subtitle");
  const elLast = document.getElementById("lastUpdate");
  const elNet = document.getElementById("net");
  const elDateTag = document.getElementById("dateTag");
  const elRot = document.getElementById("rotationTag");
  const elErr = document.getElementById("err");
  const elTopC = document.getElementById("topCountdown");
  const elTopD = document.getElementById("topDetails");
  const elCards = document.getElementById("routeCards");
  const elState = document.getElementById("serviceState");

  let schedules = null;

  /* Persist Sound/Voice toggles across kiosk auto-refresh */
  const LS_SOUND = "musalla_soundOn";
  const LS_VOICE = "musalla_voiceOn";
  let soundOn = true;
  let voiceOn = true; // default ON for station screen

  /* Rotation for next departures list */
  const PAGE_SIZE = 10;
  const TOTAL_SHOW = 20;
  const ROTATE_MS = 8000;
  let pageIndex = 0; // 0 => 1-10, 1 => 11-20
  let lastRotate = 0;

  /* Alert dedupe */
  const alerted = new Set();
  let audioCtx = null;

  const pad2 = n => String(n).padStart(2,"0");
  const now = () => new Date();
  const hhmm = d => pad2(d.getHours()) + ":" + pad2(d.getMinutes());
  const ymd = d => d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());

  function showErr(msg){
    if(!elErr) return;
    elErr.style.display = "block";
    elErr.textContent = msg;
  }
  function clearErr(){
    if(!elErr) return;
    elErr.style.display = "none";
    elErr.textContent = "";
  }

  function loadTogglePrefs(){
    try{
      const s = localStorage.getItem(LS_SOUND);
      const v = localStorage.getItem(LS_VOICE);
      soundOn = (s === null) ? true : (s === "1");
      voiceOn = (v === null) ? true : (v === "1");
    }catch(e){}
    syncButtons();
  }
  function saveTogglePrefs(){
    try{
      localStorage.setItem(LS_SOUND, soundOn ? "1" : "0");
      localStorage.setItem(LS_VOICE, voiceOn ? "1" : "0");
    }catch(e){}
  }

  function syncButtons(){
    const sb = document.getElementById("soundBtn");
    const vb = document.getElementById("voiceBtn");
    const st = document.getElementById("soundTxt");
    const vt = document.getElementById("voiceTxt");

    if(sb){
      sb.classList.toggle("off", !soundOn);
      if(st) st.textContent = soundOn ? "Sound: ON" : "Sound: OFF";
    }
    if(vb){
      vb.classList.toggle("off", !voiceOn);
      if(vt) vt.textContent = voiceOn ? "Voice: ON" : "Voice: OFF";
    }
  }

  function ensureAudio(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === "suspended"){ try{ audioCtx.resume(); }catch(e){} }
  }
  function beepOnce(durationMs = 140, frequency = 880, volume = 0.20){
    ensureAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "sine";
    osc.frequency.value = frequency;
    gain.gain.value = volume;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    setTimeout(()=>{ try{osc.stop();}catch(e){} }, durationMs);
  }
  function beepPattern(){
    // 5 short beeps (noticeable but not too annoying)
    const freqs = [880, 880, 988, 880, 1046];
    const gap = 140, dur = 120;
    freqs.forEach((f,i)=> setTimeout(()=>beepOnce(dur, f, 0.20), i*(dur+gap)));
  }

  function speakBilingual(enText, arText){
    try{
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();

      const u1 = new SpeechSynthesisUtterance(enText);
      u1.lang = "en-US";
      u1.rate = 1.0;

      const u2 = new SpeechSynthesisUtterance(arText);
      u2.lang = "ar-AE";
      u2.rate = 0.95;

      // chain
      u1.onend = ()=> { try{ window.speechSynthesis.speak(u2); }catch(e){} };
      window.speechSynthesis.speak(u1);
    }catch(e){}
  }

  // ---------- Notification overlay ----------
  const notifOverlay = document.getElementById("notifOverlay");
  const notifTitle = document.getElementById("notifTitle");
  const notifContent = document.getElementById("notifContent");
  const notifTimer = document.getElementById("notifTimer");
  const notifCreated = document.getElementById("notifCreated");
  const notifClose = document.getElementById("notifClose");
  let lastNotifId = "";
  let notifHideTimer = null;
  let notifTickTimer = null;
  let notifEndsAt = 0;

  function fmtMMSS(ms){
    if(ms < 0) ms = 0;
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const r = s%60;
    return pad2(m) + ":" + pad2(r);
  }

  function hideNotification(){
    if(notifHideTimer){ clearTimeout(notifHideTimer); notifHideTimer = null; }
    if(notifTickTimer){ clearInterval(notifTickTimer); notifTickTimer = null; }
    if(notifOverlay) notifOverlay.style.display = "none";
  }

  function showNotification(payload){
    if(!payload || !payload.active) return;

    lastNotifId = String(payload.id || payload.created_at || Date.now());
    const title = String(payload.title || "Notice").trim();
    const content = String(payload.content || "").trim();
    const durSec = Math.max(5, Math.min(parseInt(payload.duration || 20, 10) || 20, 600));

    if(notifTitle) notifTitle.textContent = title;
    if(notifContent) notifContent.textContent = content;
    if(notifCreated){
      const ts = payload.created_at ? String(payload.created_at) : "";
      notifCreated.textContent = ts ? ("Sent: " + ts) : "";
    }

    if(notifOverlay) notifOverlay.style.display = "flex";

    // Sound + voice (browser may require a user gesture once; we attempt anyway)
    try{ if(soundOn) beepPattern(); }catch(e){}
    try{
      if(voiceOn){
        const en = "Attention please. " + title + ". " + content;
        const ar = "تنبيه. " + title + ". " + content;
        speakBilingual(en, ar);
      }
    }catch(e){}

    // Auto hide
    notifEndsAt = Date.now() + durSec*1000;
    if(notifTimer) notifTimer.textContent = fmtMMSS(notifEndsAt - Date.now());
    if(notifTickTimer) clearInterval(notifTickTimer);
  setInterval(()=>{
      if(!notifTimer) return;
      const left = notifEndsAt - Date.now();
      notifTimer.textContent = fmtMMSS(left);
      if(left <= 0) hideNotification();
    }, 250);

    if(notifHideTimer) clearTimeout(notifHideTimer);
    notifHideTimer = setTimeout(hideNotification, durSec*1000);
  }

  async function fetchJsonSmart(baseUrls){
    const stamp = String(Date.now());
    for(const u of baseUrls){
      const url = u + stamp;
      try{
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) continue;
        return await res.json();
      }catch(e){}
    }
    return null;
  }

  async function checkNotification(){
    const payload = await fetchJsonSmart(NOTIF_URLS);
    if(!payload || !payload.active) return;
    const pid = String(payload.id || payload.created_at || "");
    if(!pid) return;
    if(pid === lastNotifId) return;
    showNotification(payload);
  }

  // Start notification polling
  setInterval(checkNotification, 4000);
  checkNotification();

  if(notifClose) notifClose.addEventListener("click", hideNotification);
  // help unlock audio on the first user gesture (touch/click)
  document.addEventListener("click", ()=>{ try{ ensureAudio(); }catch(e){} }, { once:true });

  function parseTime(dateStr, t){
    const parts = String(t||"").split(":");
    const H = parseInt(parts[0]||"0",10);
    const M = parseInt(parts[1]||"0",10);
    const d = new Date(dateStr + "T00:00:00");
    d.setHours(H, M, 0, 0);
    return d;
  }

  function fmtCountdown(ms){
    if(ms < 0) ms = 0;
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const r = s%60;
    return pad2(m) + ":" + pad2(r);
  }

  function statusTag(ms){
    const min = ms/60000;
    if(min <= 2) return {cls:"danger", txt:"Now"};
    if(min <= 10) return {cls:"warn", txt:"Soon"};
    return {cls:"good", txt:"Upcoming"};
  }

  function routeKey(route){
    const s = String(route||"").toUpperCase().replace(/\s+/g,"").trim();
    const m = s.match(/AJ0*([0-9]{1,2})/);
    if(m) return "AJ" + String(parseInt(m[1],10));
    return s;
  }
  function routePriority(route){
    const k = routeKey(route);
    const idx = ROUTE_PRIORITY.indexOf(k);
    return (idx >= 0) ? idx : 999;
  }
  function routeColor(route){
    const k = routeKey(route);
    return ROUTE_COLORS[k] || "var(--accent)";
  }

  async function fetchFirst(){
    for(const u of CANDIDATE_URLS){
      try{
        const r = await fetch(u, {cache:"no-store"});
        if(r.ok) return {url:u, json: await r.json()};
      }catch(e){}
    }
    throw new Error("Failed to load schedules.json. Check that schedules.json exists at /bus-schedules/data/ or /bus-schedules/.");
  }

  function findDayForToday(routeObj, todayISO){
    if(!routeObj || !routeObj.days) return null;
    return routeObj.days.find(d => d.date === todayISO) || null;
  }

  function getTomorrowFirstTrip(todayISO){
    if(!schedules || !schedules.routes) return null;
    const d = new Date(todayISO + "T00:00:00");
    d.setDate(d.getDate() + 1);
    const tISO = ymd(d);

    let best = null; // {time, route, bus}
    schedules.routes.forEach(r=>{
      const day = r.days ? r.days.find(x=>x.date===tISO) : null;
      if(!day) return;
      (day.buses||[]).forEach(b=>{
        (b.departures||[]).forEach(t=>{
          const dt = parseTime(tISO, t);
          if(!best || dt < best.dt){
            best = {dt, time: t, route: r.route, bus: b.bus, date: tISO};
          }
        });
      });
    });
    return best;
  }

  function buildUpcoming(todayISO){
    const nowD = now();
    const nowMs = nowD.getTime();
    let list = [];
    schedules.routes.forEach(r=>{
      const day = findDayForToday(r, todayISO);
      if(!day) return;
      (day.buses||[]).forEach(b=>{
        (b.departures||[]).forEach(t=>{
          const dt = parseTime(todayISO, t);
          const ms = dt.getTime() - nowMs;
          if(ms >= 0){
            list.push({
              dt, ms, time: t, route: r.route, bus: b.bus,
              destination: (r.display_name || r.route)
            });
          }
        });
      });
    });
    list.sort((a,b)=>a.ms - b.ms);
    return list;
  }

  function renderTop(nextItem, todayISO){
    elDateTag.textContent = "Date: " + todayISO;

    if(!nextItem){
      elTopC.textContent = "--:--";
      elTopD.textContent = "No upcoming trips";
      return;
    }
    elTopC.textContent = fmtCountdown(nextItem.ms);
    elTopD.textContent = "Route " + nextItem.route + "  •  Bus " + nextItem.bus + "  •  " + nextItem.time;
  }

  function renderDeparturesTable(upcoming, todayISO){
    // rotation 1–10 then 11–20
    const sliced = upcoming.slice(0, TOTAL_SHOW);
    const start = pageIndex * PAGE_SIZE;
    const view = sliced.slice(start, start + PAGE_SIZE);

    if(elRot){
      const a = start + 1;
      const b = Math.min(start + PAGE_SIZE, sliced.length || (start+PAGE_SIZE));
      elRot.textContent = "Showing " + a + "–" + b;
    }

    if(!view.length){
      elRows.innerHTML = '<tr><td colspan="6" class="muted">No upcoming trips</td></tr>';
      return;
    }

    elRows.innerHTML = "";
    view.forEach(item=>{
      const tag = statusTag(item.ms);
      const tr = document.createElement("tr");

      const tdT = document.createElement("td");
      tdT.className = "time";
      tdT.textContent = item.time;

      const tdC = document.createElement("td");
      tdC.textContent = fmtCountdown(item.ms);

      const tdS = document.createElement("td");
      tdS.innerHTML = `<span class="tag ${tag.cls}">${tag.txt}</span>`;

      const tdB = document.createElement("td");
      tdB.textContent = item.bus;

      const tdR = document.createElement("td");
      tdR.className = "route";
      const rc = routeColor(item.route);
      tdR.innerHTML = `<span class="tag route" style="border-color:${rc};color:${rc}">${item.route}</span>`;

      const tdD = document.createElement("td");
      tdD.textContent = item.destination || "-";

      tr.appendChild(tdT); tr.appendChild(tdC); tr.appendChild(tdS); tr.appendChild(tdB); tr.appendChild(tdR); tr.appendChild(tdD);
      elRows.appendChild(tr);
    });
  }

  function renderRouteCards(upcoming, todayISO){
    // Next per route mini-cards (super clear for passengers)
    const nextByRoute = {};
    upcoming.forEach(it=>{
      if(!nextByRoute[it.route]) nextByRoute[it.route] = it;
    });

    const routesToday = schedules.routes
      .filter(r => !!findDayForToday(r, todayISO))
      .slice()
      .sort((a,b)=>{
        const pa = routePriority(a.route);
        const pb = routePriority(b.route);
        if(pa !== pb) return pa - pb;
        return String(a.route).localeCompare(String(b.route));
      });

    if(!routesToday.length){
      elCards.innerHTML = '<div class="muted">No schedules for today</div>';
      return;
    }

    elCards.innerHTML = "";
    routesToday.forEach(r=>{
      const it = nextByRoute[r.route] || null;

      const card = document.createElement("div");
      card.className = "rcard";
      card.style.setProperty("--accent", routeColor(r.route));
      card.style.setProperty("border-color","rgba(255,255,255,0.10)");

      const left = document.createElement("div");
      left.className = "rL";
      left.innerHTML = `
        <div class="rName">${r.route}</div>
        <div class="rSub">${r.display_name || r.route}</div>
      `;

      const right = document.createElement("div");
      right.style.textAlign = "right";

      if(it){
        right.innerHTML = `
          <div class="rT">${it.time}</div>
          <div class="rB">Bus ${it.bus} • in ${Math.max(0, Math.round(it.ms/60000))} min</div>
        `;
      }else{
        right.innerHTML = `
          <div class="rT">—</div>
          <div class="rB">No more trips today</div>
        `;
      }

      card.style.setProperty("box-shadow","none");
      card.style.borderColor = "rgba(255,255,255,0.10)";
      card.style.background = "rgba(255,255,255,0.04)";
      card.style.position = "relative";
      card.style.overflow = "hidden";
      card.style.paddingLeft = "14px";
      card.style.setProperty("padding","12px 12px 12px 12px");
      card.style.setProperty("border-radius","16px");
      card.style.setProperty("display","flex");
      card.style.setProperty("justify-content","space-between");
      card.style.setProperty("align-items","center");

      // left color bar
      const bar = document.createElement("div");
      bar.style.position="absolute";
      bar.style.left="0";
      bar.style.top="0";
      bar.style.bottom="0";
      bar.style.width="8px";
      bar.style.background = routeColor(r.route);
      bar.style.opacity="0.95";
      card.appendChild(bar);

      card.appendChild(left);
      card.appendChild(right);
      elCards.appendChild(card);
    });
  }

  function serviceEndedMessage(todayISO, upcoming){
    // After last trip, show “Service ended — next service starts tomorrow at XX:XX”.
    if(upcoming.length) return null;

    const tmr = getTomorrowFirstTrip(todayISO);
    if(!tmr) return "Service ended — no schedules found for tomorrow";
    return "Service ended — next service starts tomorrow at " + tmr.time + " (Route " + tmr.route + ", Bus " + tmr.bus + ")";
  }

  function checkAlerts(nextItem, todayISO){
    if(!nextItem) return;
    if(!soundOn && !voiceOn) return;

    // Alert window: 2 minutes before departure (including at departure)
    const min = nextItem.ms / 60000;
    if(min < 0 || min > 2) return;

    const key = todayISO + "|" + nextItem.route + "|" + nextItem.bus + "|" + nextItem.time;
    if(alerted.has(key)) return;
    alerted.add(key);

    if(soundOn){
      beepPattern();
    }
    if(voiceOn){
      const en = `Next trip. Route ${nextItem.route}. Bus ${nextItem.bus}. Departure ${nextItem.time}.`;
      const ar = `الرحلة التالية. خط ${nextItem.route}. حافلة رقم ${nextItem.bus}. وقت المغادرة ${nextItem.time}.`;
      speakBilingual(en, ar);
    }
  }

  async function load(){
    try{
      clearErr();
      const out = await fetchFirst();
      schedules = out.json;

      // Override route colors from schedules.json (if provided)
      try{
        if(schedules && schedules.route_colors){
          for(const [k,v] of Object.entries(schedules.route_colors)){
            const kk = String(k||"").toUpperCase().replace(/\s+/g,"");
            if(kk){ ROUTE_COLORS[kk] = v; }
          }
        }
      }catch(e){}


      const todayISO = ymd(now());
      elSub.textContent = "Today: " + todayISO + " • Live countdown based on device time";
      elLast.textContent = "Last update: " + (schedules.generated_at || "-");
      elNet.textContent = "Online: " + (navigator.onLine ? "Yes" : "No");

      // If today not found in ANY route => show "No schedules for today" (no fallback)
      const anyToday = (schedules.routes || []).some(r => !!findDayForToday(r, todayISO));
      if(!anyToday){
        elRows.innerHTML = '<tr><td colspan="6" class="muted">No schedules for today</td></tr>';
        elCards.innerHTML = '<div class="muted">No schedules for today</div>';
        elTopC.textContent = "--:--";
        elTopD.textContent = "No schedules for today";
        if(elState) elState.textContent = "No schedules for today";
        return;
      }

      const upcoming = buildUpcoming(todayISO);
      const nextItem = upcoming[0] || null;

      renderTop(nextItem, todayISO);
      renderDeparturesTable(upcoming, todayISO);
      renderRouteCards(upcoming, todayISO);

      const ended = serviceEndedMessage(todayISO, upcoming);
      if(elState){
        elState.textContent = ended ? ended : "Service running";
      }

      // Also show ended state in top if applicable
      if(ended){
        elTopD.textContent = ended;
      }

      checkAlerts(nextItem, todayISO);
    }catch(e){
      showErr(String(e && e.message ? e.message : e));
    }
  }

  function rotateIfNeeded(){
    const t = Date.now();
    if(t - lastRotate >= ROTATE_MS){
      lastRotate = t;
      pageIndex = (pageIndex + 1) % 2; // 0<->1
    }
  }

  function tick(){
    elClock.textContent = hhmm(now());
    rotateIfNeeded();
    // Re-render from already-loaded schedules (fast), but if not yet, do nothing.
    if(!schedules || !schedules.routes) return;

    const todayISO = ymd(now());
    const anyToday = (schedules.routes || []).some(r => !!findDayForToday(r, todayISO));
    if(!anyToday){
      elRows.innerHTML = '<tr><td colspan="6" class="muted">No schedules for today</td></tr>';
      elCards.innerHTML = '<div class="muted">No schedules for today</div>';
      elTopC.textContent = "--:--";
      elTopD.textContent = "No schedules for today";
      if(elState) elState.textContent = "No schedules for today";
      return;
    }

    const upcoming = buildUpcoming(todayISO);
    const nextItem = upcoming[0] || null;

    renderTop(nextItem, todayISO);
    renderDeparturesTable(upcoming, todayISO);
    renderRouteCards(upcoming, todayISO);

    const ended = serviceEndedMessage(todayISO, upcoming);
    if(elState){
      elState.textContent = ended ? ended : "Service running";
    }
    if(ended){
      elTopD.textContent = ended;
    }

    checkAlerts(nextItem, todayISO);
  }

  function onSoundToggle(){
    soundOn = !soundOn;
    saveTogglePrefs();
    syncButtons();
    // Important: audio needs user gesture at least once in many browsers; we re-init here.
    if(soundOn){
      try{ ensureAudio(); beepOnce(90, 700, 0.12); }catch(e){}
    }
  }
  function onVoiceToggle(){
    voiceOn = !voiceOn;
    saveTogglePrefs();
    syncButtons();
    if(voiceOn){
      speakBilingual("Voice alerts enabled.", "تم تفعيل التنبيه الصوتي.");
    }else{
      try{ if("speechSynthesis" in window) window.speechSynthesis.cancel(); }catch(e){}
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    loadTogglePrefs();

    const sb = document.getElementById("soundBtn");
    const vb = document.getElementById("voiceBtn");
    if(sb) sb.addEventListener("click", onSoundToggle);
    if(vb) vb.addEventListener("click", onVoiceToggle);

    elClock.textContent = hhmm(now());
    load();
    setInterval(tick, 1000);
    setInterval(load, 60*1000);
  });

})();
</script>
</body>
</html>
