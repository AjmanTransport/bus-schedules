<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ajman Transport ‚Äî Bus Schedules</title>
  <style>
    :root{
      --primary:#1f4e79;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#12212f;
      --muted:#6b7a8a;
      --border:#e5e9f0;
      --good:#e8fff0;
      --warn:#fff6e6;
      --shadow:0 2px 10px rgba(16,24,40,.04);
    }
    body{margin:0;font-family:system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text);}
    header{background:linear-gradient(90deg,var(--primary),#2b6aa2);color:#fff;padding:18px 16px;}
    header h1{margin:0;font-size:18px;font-weight:800;}
    header .sub{opacity:.9;margin-top:6px;font-size:12px;line-height:1.45}
    .wrap{max-width:1100px;margin:0 auto;padding:14px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:var(--shadow);}
    .card h2{margin:0 0 10px 0;font-size:14px}
    .routes{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid rgba(31,78,121,.25);
      background:#fff;
      border-radius:999px;
      padding:9px 12px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
    }
    .btn.active{background:rgba(31,78,121,.08);border-color:rgba(31,78,121,.45)}
    .meta{font-size:12px;color:var(--muted)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,input{padding:9px 10px;border-radius:10px;border:1px solid var(--border);background:#fff}
    .tablewrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:740px}
    thead th{
      position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);
      padding:10px;font-size:12px;text-align:left;z-index:2
    }
    tbody td{padding:10px;border-bottom:1px solid var(--border);font-size:12px;vertical-align:top}
    tbody tr:hover{background:#f8fbff}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef4ff;border:1px solid #d9e6ff;font-size:11px;font-weight:700}
    .pill{display:inline-block;padding:7px 10px;border-radius:12px;margin:3px;border:1px solid #e6ebf2;background:#fff}
    .pill.next{background:var(--good);border-color:#b6f2c8}
    .pill.soon{background:var(--warn);border-color:#ffe2a8}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{flex:1;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .kpi .title{font-size:12px;color:var(--muted);margin-bottom:6px}
    .kpi .value{font-size:18px;font-weight:800}
    .kpi .subv{font-size:12px;color:var(--muted);margin-top:4px}
    footer{padding:18px 14px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
<header>
  <h1>Ajman Transport ‚Äî Bus Trip Schedules</h1>
  <div class="sub">
    Public Transport Department ‚Ä¢ Business Planning and Development Section<br/>
    Software developed by: Abdelhameed Altoum
  </div>
</header>

<div class="wrap">
  <div class="row">
    <div class="card" style="flex:1;min-width:280px">
      <h2>Select Route</h2>
      <div class="routes" id="routeButtons"></div>
      <div class="meta" id="lastUpdated" style="margin-top:10px"></div>
    </div>

    <div class="card" style="flex:2;min-width:320px">
      <h2>Filters</h2>
      <div class="toolbar">
        <label class="meta">Date</label>
        <select id="dateSelect"></select>

        <label class="meta">Bus</label>
        <select id="busSelect"><option value="ALL">All</option></select>

        <label class="meta">Search time</label>
        <input id="timeSearch" placeholder="e.g. 07:30" style="width:120px"/>

        <button class="btn" id="soundBtn" type="button">üîá Sound Alerts: OFF</button>
        <button class="btn" id="voiceBtn" type="button">üó£Ô∏è Voice: OFF</button>
      </div>
      <div class="meta" style="margin-top:10px">Times are 24-hour format (HH:MM). Alerts require one tap to enable sound.</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h2 style="margin:0 0 10px 0">Next Departures</h2>
    <div class="kpi" id="nextPanel"></div>
    <div class="meta" style="margin-top:10px">Upcoming highlights are based on your phone time. Version: 1771179725</div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="align-items:center;justify-content:space-between">
      <h2 id="tableTitle" style="margin:0">Timetable</h2>
      <a class="btn" id="pdfLink" href="schedule.pdf?v=1771179725" style="text-decoration:none">Download PDF (optional)</a>
    </div>

    <div class="tablewrap" style="margin-top:10px">
      <table>
        <thead>
          <tr>
            <th style="width:120px">Bus</th>
            <th>Departures (sorted)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<footer>¬© Ajman Transport ‚Äî Bus Schedules</footer>

<script>
let DATA=null;
let currentRoute=null;

function toMinutes(t){
  const [h,m]=t.split(":").map(Number);
  return h*60+m;
}
function nowMinutes(){
  const d=new Date();
  return d.getHours()*60+d.getMinutes();
}
function classifyTime(t){
  const diff = toMinutes(t) - nowMinutes();
  if(diff>=0 && diff<=2) return "next";
  if(diff>=0 && diff<=10) return "soon";
  return "";
}
function sortTimes(times){
  return [...times].sort((a,b)=>toMinutes(a)-toMinutes(b));
}
function uniqueSorted(times){
  return sortTimes(Array.from(new Set(times)));
}

/* Sound + Voice Alerts */
let soundEnabled = false;
let voiceEnabled = false;
let alreadyAlerted = new Set();
let audioCtx = null;

function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  // iOS / Chrome requires user gesture; this is called after user toggles sound.
  if(audioCtx.state === "suspended"){ try{ audioCtx.resume(); }catch(e){} }
}

function beepOnce(durationMs = 160, frequency = 880, volume = 0.18) {
  ensureAudio();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = "sine";
  osc.frequency.value = frequency;
  gain.gain.value = volume;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  setTimeout(()=>{ try{osc.stop();}catch(e){} }, durationMs);
}

function beepPattern(count = 5){
  // Short, noticeable pattern but not too annoying: 5 beeps with slight pitch variation.
  const freqs = [880, 880, 988, 880, 1046];
  const gap = 160;
  const dur = 140;
  for(let i=0;i<Math.min(count, freqs.length);i++){
    setTimeout(()=>beepOnce(dur, freqs[i], 0.20), i*(dur+gap));
  }
}

function speak(text){
  try{
    if(!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 1.0;
    u.pitch = 1.0;
    window.speechSynthesis.speak(u);
  }catch(e){}
}

function toggleSound(){
  soundEnabled = !soundEnabled;
  const btn = document.getElementById("soundBtn");
  btn.textContent = soundEnabled ? "üîä Sound Alerts: ON" : "üîá Sound Alerts: OFF";
  alreadyAlerted.clear();
  if(soundEnabled){
    try{ beepOnce(90, 700, 0.10); }catch(e){}
  }
}

function toggleVoice(){
  voiceEnabled = !voiceEnabled;
  const btn = document.getElementById("voiceBtn");
  btn.textContent = voiceEnabled ? "üó£Ô∏è Voice: ON" : "üó£Ô∏è Voice: OFF";
  alreadyAlerted.clear();
  if(voiceEnabled){
    // Speak a quick sample to confirm
    speak("Voice alerts enabled.");
  }
}

function checkNextTripAlerts(){
  if((!soundEnabled && !voiceEnabled) || !currentRoute) return;

  const date = document.getElementById("dateSelect").value || currentRoute.days[0].date;
  const busFilter = document.getElementById("busSelect").value || "ALL";
  const day = currentRoute.days.find(x=>x.date===date) || currentRoute.days[0];

  day.buses
    .filter(b => busFilter==="ALL" ? true : b.bus===busFilter)
    .forEach(b => {
      uniqueSorted(b.departures || []).forEach(t => {
        const diff = toMinutes(t) - nowMinutes();
        // Alert window: 2 minutes before departure (including at departure time)
        if(diff>=0 && diff<=2){
          const key = `${currentRoute.route}|${day.date}|${b.bus}|${t}`;
          if(!alreadyAlerted.has(key)){
            alreadyAlerted.add(key);

            if(soundEnabled){
              beepPattern(5);
            }
            if(voiceEnabled){
              speak(`Next trip. Route ${currentRoute.route}. Bus ${b.bus}. Departure ${t}.`);
            }
          }
        }
      });
    });
}

/* UI Rendering */
async function load(){
  const res = await fetch("data/schedules.json?v=" + Date.now());
  DATA = await res.json();
  document.getElementById("lastUpdated").textContent = "Last updated: " + (DATA.generated_at || "‚Äî");
  renderRouteButtons();
}

function renderRouteButtons(){
  const box = document.getElementById("routeButtons");
  box.innerHTML="";
  DATA.routes.forEach((r,i)=>{
    const b=document.createElement("button");
    b.className="btn" + (i===0 ? " active" : "");
    b.textContent = r.display_name || r.route;
    b.onclick = ()=>selectRoute(r.route);
    box.appendChild(b);
  });
  selectRoute(DATA.routes[0].route);
}

function selectRoute(routeCode){
  currentRoute = DATA.routes.find(r=>r.route===routeCode);
  document.querySelectorAll("#routeButtons .btn").forEach(btn=>{
    btn.classList.toggle("active", btn.textContent.includes(routeCode));
  });

  const ds=document.getElementById("dateSelect");
  ds.innerHTML="";
  currentRoute.days.forEach(d=>{
    const opt=document.createElement("option");
    opt.value=d.date;
    opt.textContent = d.date + " (" + d.profile + ")";
    ds.appendChild(opt);
  });

  ds.onchange = ()=>{ alreadyAlerted.clear(); renderTable(); renderNextPanel(); };
  document.getElementById("busSelect").onchange = ()=>{ alreadyAlerted.clear(); renderTable(); renderNextPanel(); };
  document.getElementById("timeSearch").oninput = renderTable;

  document.getElementById("pdfLink").href = "schedule.pdf?v=" + Date.now();

  renderBusDropdown();
  renderTable();
  renderNextPanel();
}

function renderBusDropdown(){
  const bs=document.getElementById("busSelect");
  const keep = bs.value || "ALL";
  bs.innerHTML = '<option value="ALL">All</option>';

  const date = document.getElementById("dateSelect").value || currentRoute.days[0].date;
  const day = currentRoute.days.find(x=>x.date===date) || currentRoute.days[0];

  day.buses.forEach(b=>{
    const opt=document.createElement("option");
    opt.value=b.bus;
    opt.textContent=b.bus;
    bs.appendChild(opt);
  });

  if([...bs.options].some(o=>o.value===keep)) bs.value=keep;
}

function renderNextPanel(){
  const panel = document.getElementById("nextPanel");
  panel.innerHTML = "";

  const date = document.getElementById("dateSelect").value || currentRoute.days[0].date;
  const busFilter = document.getElementById("busSelect").value || "ALL";
  const day = currentRoute.days.find(x=>x.date===date) || currentRoute.days[0];

  const nowM = nowMinutes();
  let all = [];
  day.buses
    .filter(b => busFilter==="ALL" ? true : b.bus===busFilter)
    .forEach(b=>{
      uniqueSorted(b.departures || []).forEach(t=>{
        const diff = toMinutes(t) - nowM;
        if(diff >= 0 && diff <= 180){
          all.push({bus:b.bus, t, diff});
        }
      });
    });

  all.sort((a,b)=>a.diff-b.diff);
  const top = all.slice(0, 6);

  if(top.length===0){
    panel.innerHTML = '<div class="box"><div class="title">Next departure</div><div class="value">‚Äî</div><div class="subv">No upcoming trips in the next 3 hours</div></div>';
    return;
  }

  top.forEach(x=>{
    const cls = classifyTime(x.t);
    const mins = Math.max(0, Math.round(x.diff));
    const box = document.createElement("div");
    box.className = "box";
    box.innerHTML = `
      <div class="title">Bus ${x.bus}</div>
      <div class="value"><span class="pill ${cls}">${x.t}</span></div>
      <div class="subv">In ${mins} min</div>
    `;
    panel.appendChild(box);
  });
}

function renderTable(){
  renderBusDropdown();

  const date = document.getElementById("dateSelect").value || currentRoute.days[0].date;
  const busFilter = document.getElementById("busSelect").value || "ALL";
  const timeSearch = (document.getElementById("timeSearch").value || "").trim();

  const day = currentRoute.days.find(x=>x.date===date) || currentRoute.days[0];
  document.getElementById("tableTitle").textContent =
    `${currentRoute.display_name || currentRoute.route} ‚Äî ${day.date} (${day.profile})`;

  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";

  day.buses
    .filter(b => busFilter==="ALL" ? true : b.bus===busFilter)
    .forEach(b=>{
      let times = uniqueSorted(b.departures || []);
      if(timeSearch) times = times.filter(t=>t.includes(timeSearch));

      const tr=document.createElement("tr");
      const td1=document.createElement("td");
      td1.innerHTML = `<span class="chip">${b.bus}</span>`;

      const td2=document.createElement("td");
      td2.innerHTML = times.map(t=>{
        const cls = classifyTime(t);
        return `<span class="pill ${cls}">${t}</span>`;
      }).join("");

      tr.appendChild(td1);
      tr.appendChild(td2);
      tbody.appendChild(tr);
    });
}

function tick(){
  renderNextPanel();
  renderTable();
  checkNextTripAlerts();
}

document.addEventListener("DOMContentLoaded", ()=>{
  const btn = document.getElementById("soundBtn");
  if(btn) btn.onclick = toggleSound;
  const vbtn = document.getElementById("voiceBtn");
  if(vbtn) vbtn.onclick = toggleVoice;
  setInterval(tick, 15000);
});

load();
</script>
</body>
</html>
